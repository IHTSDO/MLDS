<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property name="now" value="now()" dbms="mysql,h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>

    <!-- JHipster core -->
    <changeSet id="1" author="jhipster">
        <createTable tableName="T_USER">
            <column name="login" type="varchar(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="password" type="varchar(100)"/>
            <column name="first_name" type="varchar(50)"/>
            <column name="last_name" type="varchar(50)"/>
            <column name="email" type="varchar(100)"/>
        </createTable>

        <createTable tableName="T_AUTHORITY">
            <column name="name" type="varchar(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="T_USER_AUTHORITY">
            <column name="login" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="login, name" tableName="T_USER_AUTHORITY"/>

        <createTable tableName="T_PERSISTENT_TOKEN">
            <column name="series" type="varchar(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_login" type="varchar(50)"/>
            <column name="token_value" type="varchar(255)"/>
            <column name="token_date" type="date"/>
            <column name="ip_address" type="varchar(39)"/>
            <column name="user_agent" type="varchar(255)"/>
        </createTable>

        <createTable tableName="hibernate_sequences">
            <column name="sequence_name" type="varchar(255)"/>
            <column name="sequence_next_hi_value" type="integer"/>
        </createTable>

        <createIndex indexName="idx_user_authority"
                     tableName="T_USER_AUTHORITY"
                     unique="true">
            <column name="login" type="varchar(50)"/>
            <column name="name" type="varchar(255)"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="name"
                                 baseTableName="T_USER_AUTHORITY"
                                 constraintName="fk_authority_name"
                                 referencedColumnNames="name"
                                 referencedTableName="T_AUTHORITY"/>

        <addForeignKeyConstraint baseColumnNames="login"
                                 baseTableName="T_USER_AUTHORITY"
                                 constraintName="fk_user_login"
                                 referencedColumnNames="login"
                                 referencedTableName="T_USER"/>

        <addForeignKeyConstraint baseColumnNames="user_login"
                                 baseTableName="T_PERSISTENT_TOKEN"
                                 constraintName="fk_user_persistent_token"
                                 referencedColumnNames="login"
                                 referencedTableName="T_USER"/>

        <loadData encoding="UTF-8"
                  file="config/liquibase/users.csv"
                  separator=";"
                  tableName="T_USER"/>

        <loadData encoding="UTF-8"
                  file="config/liquibase/authorities.csv"
                  separator=";"
                  tableName="T_AUTHORITY"/>

        <loadData encoding="UTF-8"
                  file="config/liquibase/users_authorities.csv"
                  separator=";"
                  tableName="T_USER_AUTHORITY"/>
    </changeSet>

    <!-- Manage the new Springboot actuator Audit event -->
    <changeSet id="2" author="jhipster">
        <createTable tableName="T_PERSISTENT_AUDIT_EVENT">
            <column name="event_id" type="bigint">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="principal" type="varchar(50)"/>
            <column name="event_date" type="date"/>
            <column name="event_type" type="varchar(50)"/>
        </createTable>

        <createTable tableName="T_PERSISTENT_AUDIT_EVENT_DATA">
            <column name="event_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)"/>
        </createTable>
        <addPrimaryKey columnNames="event_id, name" tableName="T_PERSISTENT_AUDIT_EVENT_DATA"/>

        <createIndex indexName="idx_persistent_audit_event"
                     tableName="T_PERSISTENT_AUDIT_EVENT"
                     unique="false">
            <column name="principal" type="varchar(50)"/>
            <column name="event_date" type="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_persistent_audit_event_data"
                     tableName="T_PERSISTENT_AUDIT_EVENT_DATA"
                     unique="false">
            <column name="event_id" type="bigint"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="event_id"
                                 baseTableName="T_PERSISTENT_AUDIT_EVENT_DATA"
                                 constraintName="FK_event_persistent_audit_event_data"
                                 referencedColumnNames="event_id"
                                 referencedTableName="T_PERSISTENT_AUDIT_EVENT"/>
    </changeSet>
    

    <!-- Manage the new registration facility -->
    <changeSet id="4" author="jhipster">
        <addColumn tableName="T_USER">
            <column name="activated" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="lang_key" type="varchar(5)"/>
            <column name="activation_key" type="varchar(20)"/>
            <column name="created_by" type="varchar(50)" defaultValue="system">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="timestamp" defaultValueDate="${now}">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="varchar(50)"/>
            <column name="last_modified_date" type="timestamp"/>
        </addColumn>

        <loadUpdateData encoding="UTF-8"
                  primaryKey="login"
                  file="config/liquibase/users_upd_001.csv"
                  separator=";"
                  tableName="T_USER"/>

        <loadData encoding="UTF-8"
                  file="config/liquibase/users_authorities_upd_001.csv"
                  separator=";"
                  tableName="T_USER_AUTHORITY"/>
    </changeSet>

    <!-- Sample changeSet for creating a new Entity with the entity sub-generator -->
    <!-- 
    <changeSet id="100" author="jhipster">
	    <createTable tableName="T_FOO">
            <column name="id" type="varchar(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sample_text_attribute" type="varchar(50)"/>
            <column name="sample_date_attribute" type="date"/>
        </createTable>
    </changeSet>
    -->
   	<changeSet id="MLDS-23-1" author="MB/DGJ">
   		<preConditions onFail="MARK_RAN">
   			<not><tableExists tableName="country"/></not>
   		</preConditions>
		<comment>Downloaded from http://datahub.io/dataset/iso-3166-1-alpha-2-country-codes/resource/9c3b30dd-f5f3-4bbe-a3cb-d7b2c21d66ce.</comment>
		<!-- removed unused columns, and deleted rows with duplicate iso_code_2 values (e.g. South Ossetia) -->
		<createTable tableName="country">
			<column name="iso_code_2" type="varchar(2)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="iso_code_3" type="varchar(3)" />
			<column name="common_name" type="varchar(255)" />
		</createTable>

		<loadData encoding="UTF-8" file="config/liquibase/iso_3166_1_countries.csv" separator="," tableName="country">
			<column header="ISO 3166-1 2 Letter Code" name="iso_code_2"/>
			<column header="ISO 3166-1 3 Letter Code" name="iso_code_3"/>
			<column header="Common Name" name="common_name"/>
		</loadData>
	</changeSet>

    <changeSet author="MB/DGJ" id="MLDS-23-2">
        <createTable  schemaName="public" tableName="commercial_usage">
            <column name="commercial_usage_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="timestamp"/>
            <column name="key" type="VARCHAR(255)"/>
        </createTable>
        <addPrimaryKey columnNames="commercial_usage_id" constraintName="commercial_usage_PK" schemaName="public" tableName="commercial_usage"/>
        
    </changeSet>
    <changeSet author="MB/DGL" id="MLDS-23-3" logicalFilePath="none">
        <createTable   schemaName="public" tableName="commercial_usage_entry">
            <column name="commercial_usage_entry_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="public_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="timestamp"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="start_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="date"/>
            <column name="country_iso_code_2" type="VARCHAR(255)"/>
        </createTable>
        <addPrimaryKey columnNames="commercial_usage_entry_id" constraintName="commercial_usage_entry_PK" schemaName="public" tableName="commercial_usage_entry"/>
    </changeSet>
    
    <changeSet author="MB/DGL" id="MLDS-23-4">
        <createTable   schemaName="public" tableName="commercial_usage_commercial_usage_entry">
            <column name="commercial_usage_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="commercial_usage_entry_id" type="INT8">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="commercial_usage_id, commercial_usage_entry_id" constraintName="commercial_usage_commercial_usage_entry_PK" tableName="commercial_usage_commercial_usage_entry"/>
    </changeSet>
    
    <changeSet author="MB/DGL" id="MLDS-23-5" logicalFilePath="none">
        <addForeignKeyConstraint baseColumnNames="commercial_usage_id" baseTableName="commercial_usage_commercial_usage_entry" baseTableSchemaName="public" constraintName="FK_1xn3ghkhcaywjhij48jdypi5p" deferrable="false" initiallyDeferred="false" referencedColumnNames="commercial_usage_id" referencedTableName="commercial_usage" referencedTableSchemaName="public"/>
        <addForeignKeyConstraint baseColumnNames="country_iso_code_2" baseTableName="commercial_usage_entry" baseTableSchemaName="public" constraintName="FK_commercial_usage_entry_country" deferrable="false" initiallyDeferred="false" referencedColumnNames="iso_code_2" referencedTableName="country" referencedTableSchemaName="public"/>
        <addForeignKeyConstraint baseColumnNames="commercial_usage_entry_id" baseTableName="commercial_usage_commercial_usage_entry" baseTableSchemaName="public" constraintName="FK_og8u9xh3tsghu0metiigxaa6d" deferrable="false" initiallyDeferred="false" referencedColumnNames="commercial_usage_entry_id" referencedTableName="commercial_usage_entry" referencedTableSchemaName="public"/>
    </changeSet>    

    <changeSet author="MB/DGL" id="MLDS-23-6" logicalFilePath="none">
    	<comment>Add date range to usage report</comment>
    	<addColumn tableName="commercial_usage">
    		<column name="start_date" type="DATE"/>
    	</addColumn>
    	<addColumn tableName="commercial_usage">
    		<column name="end_date" type="DATE"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="MB" author="MLDS-23-7">
    	<comment>Change entry mapping</comment>
    	<dropTable tableName="commercial_usage_commercial_usage_entry"/>
    	<dropColumn tableName="commercial_usage_entry" columnName="public_id"/>
    	<addColumn tableName="commercial_usage_entry">
    		<column name="commercial_usage_id" type="bigint">
    			<constraints foreignKeyName="FK_commercial_usage_entry_commercial_usage" references="commercial_usage(commercial_usage_id)"/>
    		</column>
   		</addColumn>
    </changeSet>
    
    <changeSet id="MB" author="MLDS-23-8">
    	<comment>Delete obsolete jhipster table</comment>
    	<dropTable tableName="hibernate_sequences"/>
    </changeSet>
    
    <changeSet id="MB" author="MLDS-23-9">
    	<comment>Add type to usage entry</comment>
    	<addColumn tableName="commercial_usage_entry">
    		<column name="type" type="VARCHAR(255)"/>
   		</addColumn>
    </changeSet>

    <changeSet id="DGJ" author="MLDS-23-10">
    	<comment>Add note to usage entry</comment>
    	<addColumn tableName="commercial_usage_entry">
    		<column name="note" type="TEXT"/>
   		</addColumn>
    </changeSet>

    <changeSet id="DGJ" author="MLDS-23-11">
    	<comment>Add note to commercial usage</comment>
    	<addColumn tableName="commercial_usage">
    		<column name="note" type="TEXT"/>
   		</addColumn>
    </changeSet>

    <changeSet id="DGJ" author="MLDS-23-12">
    	<comment>Add approval state to commercial usage</comment>
    	<addColumn tableName="commercial_usage">
    		<column name="approval_state" type="VARCHAR(255)" defaultValue="NOT_SUBMITTED"/>
			<column name="submitted" type="timestamp"/>
   		</addColumn>
    </changeSet>

    <changeSet id="DGJ" author="MLDS-23-13">
    	<comment>Introduce Affiliate as owner of commercialUsageReports</comment>
        <createTable schemaName="public" tableName="licensee">
            <column name="licensee_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="created" type="timestamp"/>
        </createTable>
        <addPrimaryKey columnNames="licensee_id" constraintName="licensee_PK" schemaName="public" tableName="licensee"/>

    	<addColumn tableName="commercial_usage">
    		<column name="licensee_id" type="INT8">
    		</column>
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="licensee_id" baseTableName="commercial_usage" baseTableSchemaName="public" constraintName="FK_commercial_usage_licensee" deferrable="false" initiallyDeferred="false" referencedColumnNames="licensee_id" referencedTableName="licensee" referencedTableSchemaName="public"/>
	</changeSet>
	
   <changeSet id="DGJ" author="MLDS-23-14">
    	<comment>Add basic link from licensee to creator</comment>
    	<addColumn tableName="licensee">
    		<column name="creator" type="VARCHAR(255)">
    			<constraints nullable="false"/>
    		</column>
   		</addColumn>
    </changeSet>

    <changeSet id="DGJ" author="MLDS-23-15">
    	<comment>Add basic link from licensee to current application</comment>
    	<addColumn tableName="licensee">
    		<column name="application_id" type="INT8">
    		</column>
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="application_id" baseTableName="licensee" baseTableSchemaName="public" constraintName="FK_licensee_application" deferrable="false" initiallyDeferred="false" referencedColumnNames="application_id" referencedTableName="application" referencedTableSchemaName="public"/>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-16">
    	<comment>Add Country Counts for Commercial Usage Report</comment>
    	<createTable schemaName="public" tableName="commercial_usage_count">
            <column name="commercial_usage_count_id" type="INT8">
                <constraints nullable="false"/>
            </column>
    		<column name="commercial_usage_id" type="bigint">
    			<constraints foreignKeyName="FK_commercial_usage_count_commercial_usage" references="commercial_usage(commercial_usage_id)"/>
    		</column>
            <column name="created" type="timestamp"/>
            <column name="practices" type="integer" defaultValue="0"/>
        </createTable>
        <addPrimaryKey columnNames="commercial_usage_count_id" constraintName="commercial_usage_count_PK" schemaName="public" tableName="commercial_usage_count"/>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-17">
    	<comment>Add Country Counts should be related to the country list</comment>
    	<addColumn tableName="commercial_usage_count">
    		<column name="country_iso_code_2" type="VARCHAR(255)"/>
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="country_iso_code_2" baseTableName="commercial_usage_count" baseTableSchemaName="public" constraintName="FK_commercial_usage_count_country" deferrable="false" initiallyDeferred="false" referencedColumnNames="iso_code_2" referencedTableName="country" referencedTableSchemaName="public"/>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-18">
    	<comment>Practices are now just counts rather than type of commercial usage entry</comment>
		<dropColumn tableName="commercial_usage_entry" columnName="type"/>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-19">
    	<comment>Mark type of licensee</comment>
    	<addColumn tableName="licensee">
    		<column name="type" type="VARCHAR(255)"/>
   		</addColumn>
   		<update tableName="licensee">
   			<column name="type" value="COMMERCIAL"/>
   		</update>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-20">
    	<comment>Generalize usage with context fields</comment>
    	<addColumn tableName="commercial_usage">
    		<column name="current_usage" type="TEXT"/>
    		<column name="future_usage" type="TEXT"/>
    		<column name="purpose" type="TEXT"/>
    		<column name="agreement_type" type="VARCHAR(255)"/>
   		</addColumn>
	</changeSet>
	
    <changeSet id="DGJ" author="MLDS-23-21">
    	<comment>Generalize usage with context fields</comment>
    	<renameColumn tableName="commercial_usage" oldColumnName="future_usage" newColumnName="planned_usage"/>
	</changeSet>

    <changeSet id="DGJ" author="MLDS-23-22">
    	<comment>Include licensee type on usage report</comment>
    	<addColumn tableName="commercial_usage">
    		<column name="type" type="VARCHAR(255)"/>
    	</addColumn>
   		<update tableName="commercial_usage">
   			<column name="type" value="COMMERCIAL"/>
   		</update>
	</changeSet>
	
    <changeSet id="MLDS-20-1" author="MB">
    	<comment>Storage for password reset tokens</comment>
    	<createTable tableName="password_reset_token">
    		<column name="password_reset_token_id" type="VARCHAR(255)">
    			<constraints primaryKey="true" primaryKeyName="password_reset_tokenPK"/>
    		</column>
    		<column name="user_login" type="VARCHAR(255)"/>
            <column name="created" type="timestamp"/>
    	</createTable>
	</changeSet>

	<changeSet id="MLDS-234-1" author="MB">
		<comment>Add flags to Country to identify Members that aren't signed up to use MLDS</comment>
		<addColumn tableName="country">
			<column name="exclude_registration" type="BOOLEAN" defaultValueBoolean="false">
				<constraints nullable="false"/>
			</column>
			<column name="alternate_registration_url" type="VARCHAR(255)"/>
		</addColumn>
	</changeSet>
	<changeSet id="MLDS-234-2" author="MB">
		<comment>Put US and UK entries in for alternative registration locations</comment>
		<sql>
			UPDATE country 
			SET exclude_registration=true, alternate_registration_url='http://www.nlm.nih.gov/'
			WHERE iso_code_2='US';
		</sql>
		<sql>
			UPDATE country 
			SET exclude_registration=true, alternate_registration_url='http://systems.hscic.gov.uk/data/uktc'
			WHERE iso_code_2='GB';
		</sql>
	</changeSet>
	
    <changeSet id="MLDS-256-1" author="DGJ">
    	<comment>Add Package</comment>
    	<createTable schemaName="public" tableName="package">
            <column name="package_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="created_at" type="timestamp"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
        </createTable>
        <addPrimaryKey columnNames="package_id" constraintName="package_PK" schemaName="public" tableName="package"/>
        <addForeignKeyConstraint baseColumnNames="created_by" baseTableName="package" baseTableSchemaName="public" constraintName="FK_package_t_user" deferrable="false" initiallyDeferred="false" referencedColumnNames="login" referencedTableName="t_user" referencedTableSchemaName="public"/>
	</changeSet>

    <changeSet id="MLDS-256-2" author="DGJ">
    	<comment>Rename Package to ReleasePackage</comment>
    	<renameTable schemaName="public" oldTableName="package" newTableName="release_package"/>
    	<renameColumn schemaName="public" tableName="release_package" oldColumnName="package_id" newColumnName="release_package_id"/>
	</changeSet>

    <changeSet id="MLDS-256-3" author="DGJ">
    	<comment>Add ReleaseVersion as child of ReleasePackage</comment>
    	<createTable schemaName="public" tableName="release_version">
            <column name="release_version_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="release_package_id" type="INT8">
       			<constraints foreignKeyName="FK_release_version_release_package" references="release_package(release_package_id)"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="created_at" type="timestamp"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="published_at" type="timestamp"/>
        </createTable>
        <addPrimaryKey columnNames="release_version_id" constraintName="release_version_PK" schemaName="public" tableName="release_version"/>
        <addForeignKeyConstraint baseColumnNames="created_by" baseTableName="release_version" baseTableSchemaName="public" constraintName="FK_release_version_t_user" deferrable="false" initiallyDeferred="false" referencedColumnNames="login" referencedTableName="t_user" referencedTableSchemaName="public"/>
	</changeSet>

    <changeSet id="MLDS-256-4" author="DGJ">
    	<comment>Add ReleaseFile as child of ReleaseVersion</comment>
    	<createTable schemaName="public" tableName="release_file">
            <column name="release_file_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="release_version_id" type="INT8">
       			<constraints foreignKeyName="FK_release_file_release_version" references="release_version(release_version_id)"/>
            </column>
            <column name="created_at" type="timestamp"/>
            <column name="label" type="VARCHAR(255)"/>
            <column name="download_url" type="TEXT"/>
        </createTable>
        <addPrimaryKey columnNames="release_file_id" constraintName="release_file_PK" schemaName="public" tableName="release_file"/>
	</changeSet>
	
	<changeSet id="MLDS-256-5" author="MB">
		<comment>Fix JH type definition of timestamp column</comment>
		<modifyDataType tableName="t_persistent_audit_event" columnName="event_date" newDataType="timestamp"/>
	</changeSet>
	
	<changeSet id="MLDS-256-6" author="MB">
		<comment>Add online flag to ReleaseVersion</comment>
		<addColumn tableName="release_version">
			<column name="online" type="BOOLEAN" defaultValueBoolean="false">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-256-7" author="DGJ">
		<comment>Add inactive_at flag/timestamp to release</comment>
		<addColumn tableName="release_version">
			<column name="inactive_at" type="timestamp"/>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-256-8" author="DGJ">
		<comment>Add inactive_at flag/timestamp to release</comment>
		<addColumn tableName="release_package">
			<column name="inactive_at" type="timestamp"/>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-274-1" author="DGJ">
		<comment>Add mgmt fields to application to support pending applications</comment>
		<addColumn tableName="application">
			<column name="submitted_at" type="timestamp"/>
			<column name="notes_internal" type="TEXT"/>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-274-2" author="DGJ">
		<comment>Migrate to application approval state</comment>
		<addColumn tableName="application">
			<column name="completed_at" type="timestamp"/>
			<column name="approval_state" type="VARCHAR(255)" defaultValue="NOT_SUBMITTED"/>
		</addColumn>
		<sql>
			UPDATE application 
			SET approval_state='NOT_SUBMITTED',submitted_at=now()
			WHERE is_submitted=FALSE;
		</sql>
		<sql>
			UPDATE application 
			SET approval_state='SUBMITTED',submitted_at=now()
			WHERE is_submitted=TRUE;
		</sql>
		<sql>
			UPDATE application 
			SET approval_state='APPROVED',completed_at=now()
			WHERE approved=TRUE;
		</sql>
		<dropColumn tableName="application" columnName="is_submitted"/>
		<dropColumn tableName="application" columnName="approved"/>
	</changeSet>

	<changeSet id="MLDS-274-3" author="DGJ">
		<comment>Associate application with the usage at time of submission</comment>
		<addColumn tableName="application">
    		<column name="commercial_usage_id" type="bigint">
    			<constraints foreignKeyName="FK_application_commercial_usage" references="commercial_usage(commercial_usage_id)"/>
    		</column>
		</addColumn>
	</changeSet>
	
	<changeSet id="MLDS-304-1" author="DGJ">
		<comment>Add implementation status</comment>
		<addColumn tableName="commercial_usage">
    		<column name="implementation_status" type="VARCHAR(255)"/>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-274-4" author="DGJ">
		<comment>Stricter application approval state</comment>
		<addNotNullConstraint 
            columnDataType="VARCHAR(255)"
            columnName="approval_state"
            defaultNullValue="NOT_SUBMITTED"
            schemaName="public"
            tableName="application"/>
	</changeSet>
	
	<changeSet id="MLDS-259-1" author="AC">
		<comment>Renaming Licensee table to Affiliate</comment>
		<renameTable newTableName="affiliate"
           oldTableName="licensee"
           schemaName="public"/>
	</changeSet>
	
	<changeSet id="MLDS-259-2" author="AC">
		<comment>Renaming Licensee columns to Affiliate</comment>
		<renameColumn             
            newColumnName="affiliate_id"
            oldColumnName="licensee_id"
            remarks="A String"
            schemaName="public"
            tableName="affiliate"/>
    <renameColumn             
            newColumnName="affiliate_id"
            oldColumnName="licensee_id"
            remarks="A String"
            schemaName="public"
            tableName="commercial_usage"/>
	</changeSet>

	<changeSet id="MLDS-259-3" author="DGJ">
		<comment>Add entity references audit log</comment>
		<addColumn tableName="t_persistent_audit_event">
    		<column name="application_id" type="bigint">
    			<constraints foreignKeyName="FK_t_persistent_audit_event_application" references="application(application_id)"/>
    		</column>
		</addColumn>
		<addColumn tableName="t_persistent_audit_event">
    		<column name="affiliate_id" type="bigint">
    			<constraints foreignKeyName="FK_t_persistent_audit_event_affiliate" references="affiliate(affiliate_id)"/>
    		</column>
		</addColumn>
		<addColumn tableName="t_persistent_audit_event">
    		<column name="release_package_id" type="bigint">
    			<constraints foreignKeyName="FK_t_persistent_audit_event_release_package" references="release_package(release_package_id)"/>
    		</column>
		</addColumn>
		<addColumn tableName="t_persistent_audit_event">
    		<column name="release_version_id" type="bigint">
    			<constraints foreignKeyName="FK_t_persistent_audit_event_release_version" references="release_version(release_version_id)"/>
    		</column>
		</addColumn>
		<addColumn tableName="t_persistent_audit_event">
    		<column name="release_file_id" type="bigint">
    			<constraints foreignKeyName="FK_t_persistent_audit_event_release_file" references="release_file(release_file_id)"/>
    		</column>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-259-4" author="DGJ">
		<comment>Remove entity foreign key constraints from audit log</comment>
		<dropForeignKeyConstraint baseTableName="t_persistent_audit_event" constraintName="FK_t_persistent_audit_event_application"/>
		<dropForeignKeyConstraint baseTableName="t_persistent_audit_event" constraintName="FK_t_persistent_audit_event_affiliate"/>
		<dropForeignKeyConstraint baseTableName="t_persistent_audit_event" constraintName="FK_t_persistent_audit_event_release_package"/>
		<dropForeignKeyConstraint baseTableName="t_persistent_audit_event" constraintName="FK_t_persistent_audit_event_release_version"/>
		<dropForeignKeyConstraint baseTableName="t_persistent_audit_event" constraintName="FK_t_persistent_audit_event_release_file"/>
	</changeSet>

    <changeSet id="MLDS-372-1" author="DGJ">
    	<comment>Add Member</comment>
    	<createTable schemaName="public" tableName="member">
            <column name="member_id" type="INT8">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(255)">
				<constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp"/>
        </createTable>
        <addPrimaryKey columnNames="member_id" constraintName="member_PK" schemaName="public" tableName="member"/>
        <addUniqueConstraint schemaName="public" tableName="member" columnNames="key" constraintName="member_name_unique"/>
	</changeSet>

    <changeSet id="MLDS-372-2" author="DGJ">
    	<comment>Load Member users</comment>
    	<sql>
			INSERT INTO member (member_id, key, created_at)
			VALUES (nextval('hibernate_sequence'), 'IHTSDO', now()); 
		</sql>
    	<sql>
			INSERT INTO member (member_id, key, created_at)
			VALUES (nextval('hibernate_sequence'), 'SE', now()); 
		</sql>
    </changeSet>
    <changeSet id="MLDS-372-3" author="MB">
    	<comment>Create login users for the IHTSDO and demo SWEDEN members</comment>
		<sql>INSERT INTO t_authority (name) values ('ROLE_STAFF'), ('ROLE_STAFF_SE'), ('ROLE_STAFF_IHTSDO')</sql>
    	<sql>
			INSERT INTO t_user (login, password, created_date)
			VALUES ('staff', 'edca6651ee089a1e0b9320988f72e62dc5339f90dcc6dbbfd82a3127d2727610b52d2b0743d9b7ff', now()),
			('sweden', 'e6b4dc6acaa889021ab202e417245c0880c66b254ad5758a298d310d15d38f1385bc0d82fc6f5e62', now()); 
		</sql>
		<sql>
			INSERT INTO t_user_authority (login, name)
			VALUES 
				('staff', 'ROLE_STAFF'),
				('staff', 'ROLE_STAFF_IHTSDO'),
				('sweden', 'ROLE_STAFF'),
				('sweden', 'ROLE_STAFF_SE')
		</sql>
    </changeSet>
	
	
	<changeSet id="MLDS-259-3" author="AC">
		<comment>Extract details object from Application and share with Affiliate</comment>
		<createTable tableName="affiliate_details">
			<column name="affiliate_details_id" type="INT8">
				<constraints nullable="false"/>
			</column>
			<column name="first_name" type="varchar(50)"/>
      <column name="last_name" type="varchar(50)"/>
      <column name="email" type="varchar(100)"/>
      <column name="alternate_email" type="varchar(100)"/>
      <column name="third_email" type="varchar(100)"/>
	  </createTable>
    <addPrimaryKey columnNames="affiliate_details_id" constraintName="affiliate_details_PK" schemaName="public" tableName="affiliate_details"/>
	</changeSet>
	
	<changeSet id="MLDS-259-4" author="AC">
		<comment>Extract details object from Application and share with Affiliate</comment>
		<createTable tableName="mailing_address">
	    <column name="address_id" type="INT8">
				<constraints nullable="false"/>
			</column>
			<column name="street" type="varchar(50)"/>
      <column name="city" type="varchar(50)"/>
    	<column name="country_iso_code_2" type="VARCHAR(255)"/>
      <column name="post" type="varchar(100)"/>
    </createTable>
    <addForeignKeyConstraint baseColumnNames="country_iso_code_2" baseTableName="mailing_address" baseTableSchemaName="public" constraintName="FK_mailing_address_country" deferrable="false" initiallyDeferred="false" referencedColumnNames="iso_code_2" referencedTableName="country" referencedTableSchemaName="public"/>
	</changeSet>
	
	<changeSet id="MLDS-259-5" author="AC">
		<comment>removing table address table</comment>
		<dropTable tableName="mailing_address"/>
	</changeSet>
	
	<changeSet id="MLDS-259-6" author="AC">
		<comment>removing table address table</comment>
		<addColumn tableName="affiliate_details">
			<column name="street" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="city" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="post" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="billing_street" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="billing_city" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="billing_post" type="varchar(50)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="country_iso_code_2" type="VARCHAR(255)"/>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="billing_country_iso_code_2" type="VARCHAR(255)"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="MLDS-259-7" author="AC">
		<comment>adding in affiliate_details_id column</comment>
		<addColumn tableName="affiliate">
			<column name="affiliate_details_id" type="INT8"></column>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="affiliate_details_id" baseTableName="affiliate" baseTableSchemaName="public" constraintName="FK_affiliate_affiliate_details" deferrable="false" initiallyDeferred="false" referencedColumnNames="affiliate_details_id" referencedTableName="affiliate_details" referencedTableSchemaName="public"/>
	</changeSet>
	
	<changeSet id="MLDS-259-8" author="AC">
		<comment>adding foreign keys to countries in addresses</comment>
		<addForeignKeyConstraint baseColumnNames="country_iso_code_2" baseTableName="affiliate_details" baseTableSchemaName="public" constraintName="FK_affiliate_details_country" deferrable="false" initiallyDeferred="false" referencedColumnNames="iso_code_2" referencedTableName="country" referencedTableSchemaName="public"/>
		<addForeignKeyConstraint baseColumnNames="billing_country_iso_code_2" baseTableName="affiliate_details" baseTableSchemaName="public" constraintName="FK_affiliate_details_billing_country" deferrable="false" initiallyDeferred="false" referencedColumnNames="iso_code_2" referencedTableName="country" referencedTableSchemaName="public"/>
	</changeSet>
	
	<changeSet id="MLDS-259-9" author="AC">
		<comment>adding missed column and updating affiliate address column types</comment>
		<addColumn tableName="affiliate">
			<column name="organization_name" type="VARCHAR(255)"></column>
		</addColumn>
		<modifyDataType tableName="affiliate_details" columnName="street" newDataType="VARCHAR(255)"/>
		<modifyDataType tableName="affiliate_details" columnName="city" newDataType="VARCHAR(255)"/>
		<modifyDataType tableName="affiliate_details" columnName="billing_street" newDataType="VARCHAR(255)"/>
		<modifyDataType tableName="affiliate_details" columnName="billing_city" newDataType="VARCHAR(255)"/>
	</changeSet>
	
	<changeSet id="MLDS-259-10" author="AC">
		<comment>dropping affiliate organization column and adding it to affiliate details</comment>
		<dropColumn tableName="affiliate" columnName="organization_name"/>
		<addColumn tableName="affiliate_details">
			<column name="organization_name" type="VARCHAR(255)"></column>
		</addColumn>
	</changeSet>
	
	<changeSet id="MLDS-372-4" author="MB">
		<comment>Add member to ReleasePackage</comment>
		<addColumn tableName="release_package">
			<column name="member_id" type="INT8">
				<constraints foreignKeyName="release_package_member" referencedTableName="member" referencedColumnNames="member_id"/>
			</column>
		</addColumn>
		<sql>
			update release_package
			set member_id = (select member_id from member where key = 'IHTSDO')
		</sql>
		<addNotNullConstraint tableName="release_package" columnName="member_id"/>
	</changeSet>
 
	<changeSet id="MLDS-259-11" author="AC">
		<comment>adding missing columns to affiliate details and adding affiliate details to application</comment>
		<addColumn tableName="affiliate_details">
			<column name="landline_number" type="VARCHAR(255)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="landline_extension" type="VARCHAR(255)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="mobile_number" type="VARCHAR(255)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="organization_type" type="VARCHAR(255)"></column>
		</addColumn>
		<addColumn tableName="affiliate_details">
			<column name="organization_type_other" type="VARCHAR(255)"></column>
		</addColumn>
		<addColumn tableName="application">
			<column name="affiliate_details_id" type="INT8"></column>
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-300-1" author="DGJ">
		<comment>Associate Country with Member</comment>
		<addColumn tableName="country">
			<column name="member_id" type="INT8">
				<constraints foreignKeyName="country_member" referencedTableName="member" referencedColumnNames="member_id"/>
			</column>
		</addColumn>
		<sql>
			<![CDATA[
			update country
			set member_id = (select member_id from member where key = 'IHTSDO')
			where iso_code_2 <> 'SE' AND exclude_registration = FALSE
			]]>
		</sql>
		<sql>
			update country
			set member_id = (select member_id from member where key = 'SE')
			where iso_code_2 = 'SE' AND exclude_registration = FALSE
		</sql>
	</changeSet>

	<changeSet id="MLDS-300-2" author="DGJ">
		<comment>Associate Member with Affiliate and Application</comment>
		<addColumn tableName="application">
			<column name="member_id" type="INT8">
				<constraints foreignKeyName="application_member" referencedTableName="member" referencedColumnNames="member_id"/>
			</column>
		</addColumn>
		<addColumn tableName="affiliate">
			<column name="home_member_id" type="INT8">
				<constraints foreignKeyName="affiliate_home_member" referencedTableName="member" referencedColumnNames="member_id"/>
			</column>
		</addColumn>
		<sql>
			update application
			set member_id = (select member_id from member where key = 'IHTSDO')
		</sql>
		<sql>
			update affiliate
			set home_member_id = (select member_id from member where key = 'IHTSDO')
		</sql>
		<addNotNullConstraint tableName="application" columnName="member_id"/>
		<addNotNullConstraint tableName="affiliate" columnName="home_member_id"/>
	</changeSet>
	
	<changeSet id="MLDS-308-1" author="MB">
		<comment>Convert application to class heirarchy.  Add discriminator column.</comment>
		<addColumn tableName="application">
			<column name="application_type" type="VARCHAR(255)" value="PRIMARY" />
		</addColumn>
		<addNotNullConstraint tableName="application" columnName="application_type" />
	</changeSet>
	
	<changeSet id="MLDS-308-2" author="MB">
		<comment>Add reason column for Extension application</comment>
		<addColumn tableName="application">
			<column name="reason" type="TEXT" />
		</addColumn>
	</changeSet>

	<changeSet id="MLDS-308-3" author="MB/DGJ">
    	<addColumn tableName="application">
    		<column name="affiliate_id" type="INT8">
    		</column>
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="affiliate_id" baseTableName="application" baseTableSchemaName="public" constraintName="FK_application_affiliate" deferrable="false" initiallyDeferred="false" referencedColumnNames="affiliate_id" referencedTableName="affiliate" referencedTableSchemaName="public"/>
        <sql>
        	delete from application as ap where not exists (select 1 from affiliate af where af.creator = ap.username)
        </sql>
        <sql>
        	update application
        	set affiliate_id = (select af.affiliate_id from affiliate af where af.creator = username)
        </sql>
        <addNotNullConstraint tableName="application" columnName="affiliate_id" />
	</changeSet>
	<changeSet id="MLDS-308-4" author="AC">
		<comment>Removing not null contraint</comment>
	  <dropNotNullConstraint tableName="application" columnName="affiliate_id" />
	</changeSet>

	<changeSet id="MLDS-325-1" author="DGJ">
		<comment>Imported affiliates may not have related user in this system</comment>
	  	<dropNotNullConstraint tableName="affiliate" columnName="creator" />
	  	<dropNotNullConstraint tableName="application" columnName="username" />
	</changeSet>

	<changeSet id="MLDS-325-2" author="DGJ">
		<comment>Record import source key</comment>
    	<addColumn tableName="application">
    		<column name="import_key" type="VARCHAR(255)">
    		</column>
    	</addColumn>
	</changeSet>

	<changeSet id="MLDS-325-3" author="DGJ">
		<comment>Record import source key</comment>
		<dropColumn tableName="application" columnName="import_key"/>
    	<addColumn tableName="affiliate">
    		<column name="import_key" type="VARCHAR(255)">
    		</column>
    	</addColumn>
	</changeSet>

	<changeSet id="MLDS-325-4" author="DGJ">
		<comment>Add remaining members</comment>
		<sql>
			UPDATE country SET exclude_registration=true, alternate_registration_url='https://nehta.org.au/aht/' WHERE iso_code_2='AU';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.health.belgium.be/eportal' WHERE iso_code_2='BE';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.moh.gov.bn/' WHERE iso_code_2='BN';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://sl.infoway-inforoute.ca/content/disppage.asp?cw_page=secure_snomedct_standards_e' WHERE iso_code_2='CA';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.ocis.cl/' WHERE iso_code_2='CL';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.ksrzis.cz/' WHERE iso_code_2='CZ';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.ssi.dk/snomedct' WHERE iso_code_2='DK';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.e-tervis.ee/index.php/en/' WHERE iso_code_2='EE';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.ehr.gov.hk/' WHERE iso_code_2='HK';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.landlaeknir.is/' WHERE iso_code_2='IS';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.nic.in/' WHERE iso_code_2='IN';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.health.gov.il/English' WHERE iso_code_2='IL';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.vpc.lt/' WHERE iso_code_2='LT';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.moh.gov.my/' WHERE iso_code_2='MY';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.ehealth.gov.mt/' WHERE iso_code_2='MT';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.nictiz.nl/' WHERE iso_code_2='NL';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.nzhis.govt.nz/moh.nsf/pagesns/497' WHERE iso_code_2='NZ';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.csioz.gov.pl/' WHERE iso_code_2='PL';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.spms.pt/' WHERE iso_code_2='PT';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.mohh.com.sg/' WHERE iso_code_2='SG';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.nczisk.sk/' WHERE iso_code_2='SK';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.mz.gov.si/en/' WHERE iso_code_2='SI';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.msps.es/profesionales/hcdsns/areaRecursosSem/snomed-ct/' WHERE iso_code_2='ES';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.socialstyrelsen.se/facksprak' WHERE iso_code_2='SE';
			UPDATE country SET exclude_registration=true, alternate_registration_url='http://www.agesic.gub.uy/' WHERE iso_code_2='UY';
		</sql>
	</changeSet>

	<changeSet id="MLDS-325-5" author="DGJ">
		<comment>Add matching members</comment>
		<sql>
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'AU', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'BE', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'BN', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'CA', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'CL', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'CZ', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'DK', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'EE', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'HK', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'IS', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'IN', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'IL', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'LT', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'MY', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'MT', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'NL', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'NZ', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'PL', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'PT', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'SG', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'SK', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'SI', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'ES', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'GB', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'US', now()); 
			INSERT INTO member (member_id, key, created_at) VALUES (nextval('hibernate_sequence'), 'UY', now()); 
		</sql>
	</changeSet>

	<changeSet id="MLDS-325-6" author="DGJ">
		<comment>Re-enable sign-up for Sweden to support manual testing...</comment>
		<sql>
			UPDATE country SET exclude_registration=false WHERE iso_code_2='SE';
		</sql>
	</changeSet>
	
	<changeSet id="MLDS-325-4" author="MB">
		<comment>Unique constraint on homeMember/importKey</comment>
		<addUniqueConstraint tableName="affiliate" columnNames="import_key, home_member_id"/>
	</changeSet>
	
	<changeSet id="MLDS-325-6" author="MB">
		<comment>Add missing constraint</comment>
		<addForeignKeyConstraint constraintName="FK_application_affiliate_details"
			baseTableName="application" 
			baseColumnNames="affiliate_details_id" 
			referencedTableName="affiliate_details" 
			referencedColumnNames="affiliate_details_id"
			 />
 	</changeSet>
 	
	<changeSet id="MLDS-309-1" author="AC">
		<comment>creating new file table for member licenses</comment>
		<createTable tableName="file">
      <column name="file_id" type="int8">
          <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="filename" type="varchar(255)"/>
      <column name="updated_at" type="timestamp"/>
      <column name="blob" type="blob"/>
      <column name="creator" type="varchar(100)"></column>
      <column name="mimetype" type="varchar(50)"></column>
    </createTable>
    <addColumn tableName="member">
    	<column name="file_id" type="INT8">
    		<constraints foreignKeyName="member_file" referencedTableName="file" referencedColumnNames="file_id"/>
    	</column>
    </addColumn>
	</changeSet>
	<changeSet id="MLDS-309-2" author="AC">
		<renameColumn tableName="member" oldColumnName="file_id" newColumnName="license_file"/>
	</changeSet>
	<changeSet id="MLDS-309-3" author="AC">
		<renameColumn tableName="file" oldColumnName="blob" newColumnName="content"/>
	</changeSet>
	<changeSet id="MLDS-309-4" author="AC/MB">
		<comment>Use blob storage for files</comment>
		<dropColumn tableName="file" columnName="content"/>
		<addColumn tableName="file">
			<column name="content" type="oid"></column>
		</addColumn>
	</changeSet>
	<changeSet id="MLDS-309-5" author="AC">
		<modifyDataType tableName="file" columnName="mimetype" newDataType="varchar(150)"/>
	</changeSet>
	
	<changeSet id="MLDS-309-6" author="ac/mb">
		<comment>Load up IHTSDO license</comment>
		<createTable tableName="tmpblob">
      <column name="content" type="bytea"/>
      <column name="o" type="oid"/>
		</createTable>
		<insert tableName="tmpblob">
      <column name="content" valueBlobFile="../../../config/Ihtsdo_AffiliateLicenceAgreement_v11.pdf"/>
		</insert>
		<sql>
			update tmpblob
				set o = lo_create(-1);
		</sql>
		<sql>
			select lowrite(lo_open((select o from tmpblob),131072), (select content from tmpblob)));
		</sql>
		<sql>
			insert into file (file_id, filename, updated_at, creator, mimetype, content)
			values (nextval('hibernate_sequence'), 'Ihtsdo_AffiliateLicenceAgreement_v11.pdf', now(), 'system', 'application/pdf', (select o from tmpblob)))
		</sql>
		<sql>
			update member 
			set license_file = (select file_id from file where file.filename = 'Ihtsdo_AffiliateLicenceAgreement_v11.pdf' limit 1)
		</sql>
		<dropTable tableName="tmpblob"/>
	</changeSet>
	
	<changeSet id="MLDS-309-7" author="AC">
		<comment>Fixing licence spelling</comment>
		<renameColumn tableName="member" oldColumnName="license_file" newColumnName="licence_file"/>
	</changeSet>

	<changeSet id="MLDS-325-7" author="DGJ">
		<comment>Add creation timestamp for applications</comment>
    	<addColumn tableName="application">
			<column name="created_at" type="timestamp"/>
    	</addColumn>
	</changeSet>

    <changeSet id="MLDS-323" author="MB">
    	<comment>Move subType from PrimaryApplication to AffiliateDetails</comment>
    	<addColumn tableName="affiliate_details">
    		<column name="subtype" type="VARCHAR(255)" afterColumn="affiliate_details_id"/>
    	</addColumn>
    	<!-- copy PA to affiliate.affilliateDetails -->
    	<sql>
    		UPDATE affiliate_details
    		SET subtype = pa.subtype
    		FROM affiliate_details AS af_ad
    		JOIN affiliate AS af ON af.affiliate_details_id = af_ad.affiliate_details_id
    		JOIN application AS pa ON pa.application_id = af.application_id
    	</sql>
    	<!-- copy pa.subtype to all applications.affiliateDetails -->
    	<sql>
    		UPDATE affiliate_details
    		SET subtype = pa.subtype
    		FROM affiliate_details AS application_ad
    		JOIN application ON application.affiliate_details_id = application_ad.affiliate_details_id
    		JOIN affiliate ON application.affiliate_id = affiliate.affiliate_id
    		JOIN application AS pa ON affiliate.application_id = pa.application_id
    	</sql>
    	<dropColumn tableName="application" columnName="subtype"/>
    </changeSet>
</databaseChangeLog>
